const { cmd } = require("../command");
const axios = require("axios");
const translate = require("google-translate-api-x");
const fs = require("fs");

cmd(
  {
    pattern: "movieinfo",
    alias: ["mv", "details"],
    desc: "Get advanced movie details with custom header and footer",
    category: "info",
    filename: __filename,
  },
  async (bot, mek, m, { from, q, reply }) => {
    try {
      if (!q) return reply("ğŸ¬ à¶šà¶»à·”à¶«à·à¶šà¶» à¶ à·’à¶­à·Šâ€à¶»à¶´à¶§à¶ºà·š à¶±à¶¸ à¶½à¶¶à· à¶¯à·™à¶±à·Šà¶±.");

      await bot.sendMessage(from, { react: { text: "ğŸ”", key: mek.key } });

      // TMDB API Data
      const apiKey = "66395349e59ca85d263920958a0329b3"; 
      const searchRes = await axios.get(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(q)}`);

      if (!searchRes.data.results || searchRes.data.results.length === 0) {
        return reply("âŒ à¶šà·’à·ƒà·’à¶¯à·” à¶ à·’à¶­à·Šâ€à¶»à¶´à¶§à¶ºà¶šà·Š à·„à¶¸à·” à¶±à·œà·€à·“à¶º.");
      }

      const movie = searchRes.data.results[0];
      const movieDetail = await axios.get(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${apiKey}`);
      const data = movieDetail.data;

      // Summary à¶‘à¶š à·ƒà·’à¶‚à·„à¶½à¶§ à¶´à¶»à·’à·€à¶»à·Šà¶­à¶±à¶º à¶šà·’à¶»à·“à¶¸
      const translation = await translate(data.overview, { to: 'si' });
      const sinhalaSummary = translation.text;

      // --- Custom Header ---
      let detailsMsg = `ğŸ…¢ğŸ…”ğŸ…’ğŸ…¡ğŸ…”ğŸ…£ ğŸ…œğŸ…ğŸ…¥ğŸ…˜ğŸ…” ğŸ…’ğŸ…›ğŸ…¤ğŸ…‘ ğŸ…’ğŸ…˜ğŸ…ğŸ…”ğŸ…œğŸ… ğŸ¦\n\n`;
      
      detailsMsg += `ğŸ“Œ *Title:* ${data.title} (${data.release_date.split("-")[0]})\n`;
      detailsMsg += `â­ *IMDb Rating:* ${data.vote_average.toFixed(1)}/10\n`;
      detailsMsg += `ğŸ“… *Release Date:* ${data.release_date}\n`;
      detailsMsg += `â±ï¸ *Runtime:* ${data.runtime} min\n\n`;
      detailsMsg += `ğŸ“ *à·ƒà·à¶»à·à¶‚à·à¶º (à·ƒà·’à¶‚à·„à¶½à·™à¶±à·Š):*\n${sinhalaSummary}\n\n`;

      // --- Custom Footer (.apply à¶‘à¶šà·™à¶±à·Š à¶‘à¶± à¶¯à·š) ---
      if (fs.existsSync("./caption.txt")) {
        const footerCaption = fs.readFileSync("./caption.txt", "utf8");
        // Footer à¶‘à¶šà·š {filename} à·€à·à¶±à·’ à¶¯à·š à¶­à·’à¶¶à·š à¶±à¶¸à·Š à¶’à·€à· à¶‰à·€à¶­à·Š à¶šà¶» à¶´à·’à¶»à·’à·ƒà·’à¶¯à·” caption à¶‘à¶š à¶œà¶±à·“
        const cleanFooter = footerCaption.replace(/{filename}/g, "").replace(/{size}/g, "").trim();
        detailsMsg += `---\n${cleanFooter}`;
      } else {
        detailsMsg += `*Generated by Movie Bot*`;
      }

      const posterPath = `https://image.tmdb.org/t/p/w500${data.poster_path}`;

      await bot.sendMessage(
        from,
        {
          image: { url: posterPath },
          caption: detailsMsg,
        },
        { quoted: mek }
      );

      await bot.sendMessage(from, { react: { text: "âœ…", key: mek.key } });

    } catch (e) {
      console.log("MOVIE ERROR:", e);
      reply("âŒ à¶­à·œà¶»à¶­à·”à¶»à·” à¶½à¶¶à· à¶œà·à¶±à·“à¶¸à·šà¶¯à·“ à¶¯à·à·‚à¶ºà¶šà·Š à·ƒà·’à¶¯à·” à·€à·’à¶º.");
    }
  }
);
